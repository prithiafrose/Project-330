<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Student Dashboard - Debug Mode</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="navbar">
  <div class="logo">Student Panel (Debug)</div>
  <div class="navbar-right">
    <button id="logout" class="logout-btn">Logout</button>
  </div>
</div>
  <!-- Sidebar -->
  <div class="sidebar">
    <a href="dashboard.html">Dashboard</a>
    <a href="job-list.html">Jobs</a>
    <a href="applied-jobs.html">Applied Jobs</a>
    <a href="profile.html">Profile</a>
     <button id="logout-btn" class="logout-btn">Logout</button>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <h1>Welcome, Student!</h1>

    <div style="background: #1b2a49; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
      <h3>Debug Information</h3>
      <div id="debugInfo">Loading debug info...</div>
    </div>

    <div class="card">
      <h3>üìä Total Jobs Available</h3>
      <p>Loading...</p>
    </div>

    <div class="card">
      <h3>üìù Applications Submitted</h3>
      <p>Loading...</p>
    </div>

    <div class="card">
      <h3>üë§ Profile Completion</h3>
      <p>Loading...</p>
    </div>
  </div>

  <script>
    console.log("=== DASHBOARD DEBUG VERSION LOADED ===");

    const API_BASE = "http://localhost:5001/api";

    function updateDebugInfo() {
      const debugDiv = document.getElementById('debugInfo');
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));

      debugDiv.innerHTML = `
        <p><strong>Token:</strong> ${token ? '‚úÖ Present' : '‚ùå Missing'}</p>
        <p><strong>User:</strong> ${user ? JSON.stringify(user) : '‚ùå Missing'}</p>
        <p><strong>Current Time:</strong> ${new Date().toLocaleTimeString()}</p>
        <p><strong>Script Status:</strong> ‚úÖ Running</p>
      `;
    }

    function getAuthHeaders() {
      const token = localStorage.getItem('token');
      if (!token) return {};
      return { 'Authorization': `Bearer ${token}` };
    }

    function setupLogout() {
      console.log("üö™ Logout clicked");
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = "../Auth/login.html";
    }

    async function loadDashboardData() {
      console.log("üîÑ Loading dashboard data...");

      const welcomeMessage = document.querySelector('.main-content h1');
      const totalJobsCard = document.querySelector('.card:nth-of-type(1) p');
      const appliedJobsCard = document.querySelector('.card:nth-of-type(2) p');
      const profileCard = document.querySelector('.card:nth-of-type(3) p');

      try {
        const res = await fetch(`${API_BASE}/student/dashboard`, {
          headers: getAuthHeaders()
        });

        console.log("Dashboard response status:", res.status);

        if (!res.ok) {
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }

        const data = await res.json();
        console.log("Dashboard data received:", data);

        // Update welcome message
        if (welcomeMessage && data.user?.full_name) {
          welcomeMessage.textContent = `Welcome, ${data.user.full_name}!`;
        }

        // Update cards
        if (totalJobsCard) {
          totalJobsCard.textContent = `Total Jobs Available: ${data.totalJobs || 0}`;
        }

        if (appliedJobsCard) {
          appliedJobsCard.textContent = `Applications Submitted: ${data.totalApplications || 0}`;
        }

        if (profileCard) {
          profileCard.textContent = `Profile Completion: ${data.profileCompletion || 0}%`;
        }

      } catch (err) {
        console.error("‚ùå Failed to load dashboard data:", err);

        // Show error in cards
        if (totalJobsCard) totalJobsCard.textContent = `Error: ${err.message}`;
        if (appliedJobsCard) appliedJobsCard.textContent = `Error: ${err.message}`;
        if (profileCard) profileCard.textContent = `Error: ${err.message}`;

        // Try fallback
        loadFallbackData();
      }
    }

    async function loadFallbackData() {
      console.log("üîÑ Loading fallback data...");

      const totalJobsCard = document.querySelector('.card:nth-of-type(1) p');
      const appliedJobsCard = document.querySelector('.card:nth-of-type(2) p');
      const profileCard = document.querySelector('.card:nth-of-type(3) p');
      const user = JSON.parse(localStorage.getItem('user'));

      // Load total jobs
      try {
        const res = await fetch(`${API_BASE}/jobs`);
        const data = await res.json();
        const jobs = data.jobs || data;
        console.log("Jobs loaded:", jobs.length);
        if (totalJobsCard) totalJobsCard.textContent = `Total Jobs Available: ${jobs.length}`;
      } catch (err) {
        console.error('‚ùå Failed to fetch jobs:', err);
        if (totalJobsCard) totalJobsCard.textContent = 'Failed to load jobs';
      }

      // Load applications
      try {
        const res = await fetch(`${API_BASE}/applications/my-applications`, {
          headers: getAuthHeaders()
        });
        const data = await res.json();
        const apps = Array.isArray(data) ? data : (data.applications || []);
        console.log("Applications loaded:", apps.length);
        if (appliedJobsCard) appliedJobsCard.textContent = `Applications Submitted: ${apps.length}`;
      } catch (err) {
        console.error('‚ùå Failed to fetch applications:', err);
        if (appliedJobsCard) appliedJobsCard.textContent = 'Failed to load applications';
      }

      // Calculate profile completion
      if (user) {
        const fields = ['full_name', 'email', 'mobile', 'skills', 'education', 'experience'];
        const filled = fields.filter(f => user[f] && user[f].toString().trim() !== '');
        const percent = Math.round((filled.length / fields.length) * 100);
        console.log("Profile completion:", percent);
        if (profileCard) profileCard.textContent = `Profile Completion: ${percent}%`;
      }
    }

    function initializeApp() {
      console.log("üöÄ Initializing debug dashboard...");

      // Setup logout buttons
      const logoutBtn = document.getElementById('logout');
      if (logoutBtn) {
        logoutBtn.addEventListener("click", setupLogout);
        console.log("‚úÖ Logout button listener attached");
      }

      const logoutBtnSidebar = document.getElementById('logout-btn');
      if (logoutBtnSidebar) {
        logoutBtnSidebar.addEventListener("click", setupLogout);
        console.log("‚úÖ Sidebar logout button listener attached");
      }

      console.log("üéâ Event listeners setup complete!");

      // Update debug info
      updateDebugInfo();
      setInterval(updateDebugInfo, 5000);

      // Load dashboard data
      loadDashboardData();
    }

    // Wait for DOM to be fully loaded
    document.addEventListener("DOMContentLoaded", initializeApp);
  </script>
</body>
</html>