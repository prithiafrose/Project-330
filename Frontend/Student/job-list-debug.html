<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Job Listings - Debug Mode</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="navbar">
  <div class="logo">Student Panel (Debug)</div>
  <div class="navbar-right">
    <button id="logout" class="logout-btn">Logout</button>
  </div>
</div>
  <!-- Sidebar -->
  <div class="sidebar">
    <a href="dashboard.html">Dashboard</a>
    <a href="job-list.html">Jobs</a>
    <a href="applied-jobs.html">Applied Jobs</a>
    <a href="profile.html">Profile</a>
     <button id="logout-btn" class="logout-btn">Logout</button>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <h1>Available Jobs (Debug Mode - Auth Bypassed)</h1>
    
    <div style="background: #1b2a49; padding: 15px; border-radius: 6px; margin-bottom: 20px;">
      <h3>Debug Information</h3>
      <div id="debugInfo">Loading debug info...</div>
    </div>

    <!-- Filters -->
    <div class="card">
      <h3>Filter Jobs</h3>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <input type="text" id="jobTitle" placeholder="Job Title">
        <input type="text" id="company" placeholder="Company">
        <input type="text" id="location" placeholder="Location">
        <input type="text" id="skills" placeholder="Skills">
        <select id="salaryRange">
          <option value="">All Salary Ranges</option>
          <option value="0-30000">Under $30,000</option>
          <option value="30000-50000">$30,000 - $50,000</option>
          <option value="50000-70000">$50,000 - $70,000</option>
          <option value="70000-100000">$70,000 - $100,000</option>
          <option value="100000+">$100,000+</option>
        </select>
        <select id="jobType">
          <option value="">All Job Types</option>
          <option value="full-time">Full Time</option>
          <option value="part-time">Part Time</option>
          <option value="contract">Contract</option>
          <option value="internship">Internship</option>
        </select>
      </div>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button id="applyFilters" class="btn">Apply Filters</button>
        <button id="clearFilters" class="btn">Clear Filters</button>
        <button id="saveFilters" class="btn">Save Filters</button>
      </div>
      <div id="activeFilters" style="margin-top: 10px; font-size: 14px; color: #64ffda;"></div>
    </div>

    <!-- Job List -->
    <div id="job-list"></div>
  </div>

   <script>
     // Debug version with bypassed auth and extensive logging
     console.log("=== DEBUG VERSION LOADED ===");
     
     const API_BASE = "http://localhost:5001/api";
     
     function updateDebugInfo() {
       const debugDiv = document.getElementById('debugInfo');
       const token = localStorage.getItem('token');
       const user = JSON.parse(localStorage.getItem('user'));
       
       debugDiv.innerHTML = `
         <p><strong>Token:</strong> ${token ? '‚úÖ Present' : '‚ùå Missing'}</p>
         <p><strong>User:</strong> ${user ? JSON.stringify(user) : '‚ùå Missing'}</p>
         <p><strong>Current Time:</strong> ${new Date().toLocaleTimeString()}</p>
         <p><strong>Script Status:</strong> ‚úÖ Running</p>
       `;
     }
     
     function escapeHTML(str) {
       if (!str) return '';
       return str.replace(/[&<>"']/g, (m) => ({
         '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
       }[m]));
     }
     
     async function fetchJobs(filters = {}) {
       console.log("Fetching jobs with filters:", filters);
       const jobListDiv = document.getElementById("job-list");
       if (!jobListDiv) return;
       
       jobListDiv.innerHTML = "<p>Loading jobs...</p>";

       try {
         const res = await fetch(`${API_BASE}/jobs`);
         const data = await res.json();
         if (!res.ok) throw new Error(data.error || "Failed to fetch jobs");

         let jobs = data.jobs || data;
         console.log("Jobs fetched:", jobs);

         // Apply filters
         if (filters.jobTitle) {
           jobs = jobs.filter(job => (job.title || job.job_position).toLowerCase().includes(filters.jobTitle.toLowerCase()));
         }
         if (filters.company) {
           jobs = jobs.filter(job => (job.company || job.company_name).toLowerCase().includes(filters.company.toLowerCase()));
         }
         if (filters.location) {
           jobs = jobs.filter(job => job.location && job.location.toLowerCase().includes(filters.location.toLowerCase()));
         }
         if (filters.skills) {
           jobs = jobs.filter(job => {
             const jobSkills = (job.skills || job.skills_required || "").toLowerCase();
             return jobSkills.includes(filters.skills.toLowerCase());
           });
         }
         if (filters.salaryRange) {
           jobs = jobs.filter(job => {
             const salary = parseFloat(job.salary || job.monthly_salary || 0);
             if (filters.salaryRange === '0-30000') return salary < 30000;
             if (filters.salaryRange === '30000-50000') return salary >= 30000 && salary < 50000;
             if (filters.salaryRange === '50000-70000') return salary >= 50000 && salary < 70000;
             if (filters.salaryRange === '70000-100000') return salary >= 70000 && salary < 100000;
             if (filters.salaryRange === '100000+') return salary >= 100000;
             return true;
           });
         }
         if (filters.jobType) {
           jobs = jobs.filter(job => {
             const jobType = (job.job_type || job.type || "").toLowerCase();
             return jobType.includes(filters.jobType.toLowerCase());
           });
         }

         if (jobs.length === 0) {
           jobListDiv.innerHTML = "<p>No jobs found matching your criteria.</p>";
           return;
         }

         jobListDiv.innerHTML = jobs.map(job => `
           <div class="job-card">
             <h4>${escapeHTML(job.title || job.job_position)}</h4>
             <p><strong>Company:</strong> ${escapeHTML(job.company || job.company_name)}</p>
             <p><strong>Location:</strong> ${escapeHTML(job.location)}</p>
             <p><strong>Salary:</strong> $${job.salary || job.monthly_salary || "N/A"}</p>
             <p><strong>Skills:</strong> ${escapeHTML(job.skills || job.skills_required || "N/A")}</p>
             <p><strong>Type:</strong> ${escapeHTML(job.job_type || job.type || "N/A")}</p>
             <a href="job-details.html?id=${job.id}" class="btn">View Details</a>
           </div>
         `).join("");

         updateActiveFilters(filters);

       } catch (err) {
         console.error("Error fetching jobs:", err);
         jobListDiv.innerHTML = `<p style="color:red">${err.message}</p>`;
       }
     }
     
     function setupLogout() {
       console.log("üö™ Logout clicked");
       alert("Logout clicked! (Debug mode - not actually logging out)");
     }
     
     function applyFilters() {
       console.log("üîç Apply Filters clicked");
       const filters = {
         jobTitle: document.getElementById("jobTitle")?.value.trim() || "",
         company: document.getElementById("company")?.value.trim() || "",
         location: document.getElementById("location")?.value.trim() || "",
         skills: document.getElementById("skills")?.value.trim() || "",
         salaryRange: document.getElementById("salaryRange")?.value || "",
         jobType: document.getElementById("jobType")?.value || "",
       };
       console.log("Filters applied:", filters);
       fetchJobs(filters);
     }
     
     function clearFilters() {
       console.log("üßπ Clear Filters clicked");
       const filterFields = ["jobTitle", "company", "location", "skills", "salaryRange", "jobType"];
       filterFields.forEach(fieldId => {
         const element = document.getElementById(fieldId);
         if (element) element.value = "";
       });
       
       const activeFiltersDiv = document.getElementById("activeFilters");
       if (activeFiltersDiv) activeFiltersDiv.innerHTML = "";
       
       fetchJobs();
     }
     
     function saveFilters() {
       console.log("üíæ Save Filters clicked");
       const filters = {
         jobTitle: document.getElementById("jobTitle")?.value.trim() || "",
         company: document.getElementById("company")?.value.trim() || "",
         location: document.getElementById("location")?.value.trim() || "",
         skills: document.getElementById("skills")?.value.trim() || "",
         salaryRange: document.getElementById("salaryRange")?.value || "",
         jobType: document.getElementById("jobType")?.value || "",
       };
       
       localStorage.setItem('jobFilters', JSON.stringify(filters));
       
       const activeFiltersDiv = document.getElementById("activeFilters");
       if (activeFiltersDiv) {
         activeFiltersDiv.innerHTML = '<span style="color: #52d8c7;">‚úì Filters saved!</span>';
         setTimeout(() => updateActiveFilters(filters), 2000);
       }
     }
     
     function loadSavedFilters() {
       const savedFilters = localStorage.getItem('jobFilters');
       if (savedFilters) {
         const filters = JSON.parse(savedFilters);
         
         Object.keys(filters).forEach(key => {
           const element = document.getElementById(key);
           if (element && filters[key]) {
             element.value = filters[key];
           }
         });
         
         return filters;
       }
       return {};
     }
     
     function updateActiveFilters(filters) {
       const activeFiltersDiv = document.getElementById("activeFilters");
       if (!activeFiltersDiv) return;
       
       const activeFilters = [];
       if (filters.jobTitle) activeFilters.push(`Title: ${filters.jobTitle}`);
       if (filters.company) activeFilters.push(`Company: ${filters.company}`);
       if (filters.location) activeFilters.push(`Location: ${filters.location}`);
       if (filters.skills) activeFilters.push(`Skills: ${filters.skills}`);
       if (filters.salaryRange) {
         const salaryText = document.getElementById("salaryRange")?.options[document.getElementById("salaryRange")?.selectedIndex]?.text;
         activeFilters.push(`Salary: ${salaryText}`);
       }
       if (filters.jobType) {
         const typeText = document.getElementById("jobType")?.options[document.getElementById("jobType")?.selectedIndex]?.text;
         activeFilters.push(`Type: ${typeText}`);
       }
       
       if (activeFilters.length > 0) {
         activeFiltersDiv.innerHTML = `<strong>Active Filters:</strong> ${activeFilters.join(' | ')}`;
       } else {
         activeFiltersDiv.innerHTML = '';
       }
     }
     
     function initializeApp() {
       console.log("üöÄ Initializing debug app...");
       
       // Setup event listeners
       const logoutBtn = document.getElementById('logout');
       if (logoutBtn) {
         logoutBtn.addEventListener("click", setupLogout);
         console.log("‚úÖ Logout button listener attached");
       }

       const logoutBtnSidebar = document.getElementById('logout-btn');
       if (logoutBtnSidebar) {
         logoutBtnSidebar.addEventListener("click", setupLogout);
         console.log("‚úÖ Sidebar logout button listener attached");
       }

       const applyFiltersBtn = document.getElementById("applyFilters");
       if (applyFiltersBtn) {
         applyFiltersBtn.addEventListener("click", applyFilters);
         console.log("‚úÖ Apply filters button listener attached");
       }

       const clearFiltersBtn = document.getElementById("clearFilters");
       if (clearFiltersBtn) {
         clearFiltersBtn.addEventListener("click", clearFilters);
         console.log("‚úÖ Clear filters button listener attached");
       }

       const saveFiltersBtn = document.getElementById("saveFilters");
       if (saveFiltersBtn) {
         saveFiltersBtn.addEventListener("click", saveFilters);
         console.log("‚úÖ Save filters button listener attached");
       }
       
       console.log("üéâ All event listeners attached!");
       
       // Update debug info
       updateDebugInfo();
       setInterval(updateDebugInfo, 5000); // Update every 5 seconds
       
       // Load saved filters and fetch jobs
       const savedFilters = loadSavedFilters();
       fetchJobs(savedFilters);
     }
     
     // Wait for DOM to be fully loaded
     document.addEventListener("DOMContentLoaded", initializeApp);
   </script>
</body>
</html>